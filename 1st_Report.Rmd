---
title: '**First Part: COVID-19 in Spain**'
subtitle: '**Advanced Regression And Prediction**'
author: '*Roberto Jes√∫s Alcaraz Molina*'
date: "09/05/2021"
output:
  pdf_document:
    number_section: true
    highlight: tango
    fig_caption: yes
    toc: true
    # toc_depth: 4
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
bibliography: references.bib
---

```{=tex}
\begin{center}
\includegraphics[width=3in]{logouc3m}
\end{center}
```
\newpage

```{r, echo = F}
pacman::p_load(COVID19, tidyverse, tidymodels, workflows, tune, patchwork, lubridate)
theme_set(theme_bw())

# spain <- COVID19::covid19(country = "spain", start = "2020-01-22", end = "2021-04-11")
# 
# clm <- COVID19::covid19(country = "spain", level = 2, start = "2020-01-22", end = "2021-04-16") %>% 
#   filter(administrative_area_level_2 == "Castilla-La Mancha")
# 
# madrid <- COVID19::covid19(country = "spain", level = 2, start = "2020-01-22", end = "2021-04-16") %>% 
#   filter(administrative_area_level_2 == "Comunidad de Madrid")

# saveRDS(spain, "spain.RDS")
# saveRDS(clm, "clm.RDS")
# saveRDS(madrid, "madrid.RDS")
```

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = F, 
                      message = FALSE,
                      eval = T,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=15,
                      cache=FALSE, error = TRUE)
```

# Introduction

The aim of this project is to analyze the coronavirus pandemic (COVID-19) in Spain in general, and in Castilla-La Mancha and Comunidad de Madrid regions, in particular, in order to see what would have happened if policy measures had been taken before. The data has been taken from the R package `COVID19` [@guidotti2020].

```{r}
spain <- readRDS("spain.RDS")
# clm <- readRDS("clm.RDS")
# madrid <- readRDS("madrid.RDS")
```

# Data Cleaning

<https://covid19datahub.io/articles/doc/data.html>

These three COVID-19 data sets contain 446 observations, which are the days from the 22nd of January 2020 until the 11th of March 2021, and 36 and 38 variables for Spain and the regions respectively, divided in 5 categories: *identifiers*, *COVID-19 variables*, *policy measures*, *geographic information* and *external keys*.

Regarding the identifiers, we will select both variables: `id`, which denote the country or the region, and date. In the second group, we have variables related with the COVID-19 such as the cumulative number of deaths, confirmed cases, test, etc. For the moment, we will select all of them and then we will decide. In the policy measures, we have very important variables for the development of the pandemic and for our study, like `workplace_closing`, `stay_home_restrictions` or `internal_movement_restrictions`, so we must take them into account. Finally, there are other geographical variables that could be interesting for our models. A description of our variables can be seen below:

```{r, eval=F}
skimr::skim(spain)
```

```{r}
population <- spain$population[1]
spain <- spain %>%
  select(date, deaths, confirmed, vaccines, hosp, icu, stay_home_restrictions, school_closing, workplace_closing, transport_closing, gatherings_restrictions, internal_movement_restrictions)
spain <- spain[, -1]

skimr::skim(spain)
```

| **Variable**                     | **Description**                                          |
|:---------------------------------|----------------------------------------------------------|
| `id`                             | Unique identifier.                                       |
| `date`                           | Observation date.                                        |
| `deaths`                         | Cumulative number of deaths.                             |
| `test`                           | Cumulative number of test.                               |
| `confirmed`                      | Cumulative number of confirmed cases.                    |
| `vaccines`                       | Cumulative number of doses administered (single dose).   |
| `hosp`                           | Number of hospitalized patients on date.                 |
| `icu`                            | Number of hospitalized patients in ICUs on date.         |
| `population`                     | Total population.                                        |
| `stay_home_restrictions`         | Indicates the measures of staying at home.               |
| `school_closing`                 | Indicates the measures in education.                     |
| `workplace_closing`              | Indicates the measures of the workplace.                 |
| `transport_closing`              | Indicates the measures in the public transport.          |
| `gatherings_restrictions`        | Indicates the measures of gatherings.                    |
| `internal_movement_restrictions` | Indicates the measures of the movements between regions. |

We have realized that all numerical variables have **missing values**. Some of them like the deaths or confirmed cases have them at the beginning, but we have no problem with that because there were not any cases at that time, so we will give 0 to these values. However, there are other variables for which we have to think what to do with their missing values very carefully. For instance, for the tests, there are 399 missing values out of 451 observations, so we will remove it because there is no much information. For the vaccines, we have 378, which we might expect that since the first day we had vaccines was the 3rd of January of 2021 but also, we have some of them in the weekends. For the number of hospitalized people and the ICU people, we have again 303 NAs, but for the moment they will remain in the data set. How to deal with these variables that have missing values will be seen in next sections. Finally, the variables for the measures do not have any missing value.

```{r}
spain <- spain %>%
  mutate(
    deaths = replace(deaths, is.na(deaths), 0),
    confirmed = replace(confirmed, is.na(confirmed), 0)
  )

spain$vaccines[1:348] <- 0
```

After that, we should modify our categorical variables, since they are encoded as integers. The first one, `stay_home_restrictions`, will have three categories: no measures, require not leaving house with exceptions (exercise) and not leaving the house. The next one, `school_closing` has another four categories: no measures, recommended closing, require closing for some schools and require closing. For `workplace_closing` we have no measures, recommended closing, require closing for some sectors and require closing. For `transport_closing` we have two levels: no measures and recommended closing. For `gatherings_restrictions`: no measures, restrictions between 10-100 people and restrictions on gatherings of less than 10 people. Finally, the variable `internal_movement_restrictions` has no measures, recommend closing or require closing.

```{r}
# For Spain
spain <- spain %>%
  mutate(
    stay_home = factor(stay_home_restrictions, 
                       levels = c(0, 1, 2),
                       labels = c("no", "recommended", "mandatory")),
    
    school_closing = factor(school_closing, 
                            levels = c(0, 1, 2, 3),
                            labels = c("no", "recommended", "require", "mandatory")),
    
    workplace_closing = factor(workplace_closing, 
                               levels = c(0, 1, 2, 3),
                               labels = c("no", "recommended", "require", "mandatory")),
    
    transport_closing = factor(transport_closing, 
                               levels = c(0, 1),
                               labels = c("no", "recommended")),
    
    gatherings_restrictions = factor(gatherings_restrictions, 
                                     levels = c(0, 1, 2, 3, 4),
                                     labels = c("no", "no", "no", "10-100", "<10")),
    
    internal_movement = factor(internal_movement_restrictions, 
                               levels = c(0, 1, 2),
                               labels = c("no", "recommended", "mandatory")),
  ) %>%
  select(-stay_home_restrictions, -internal_movement_restrictions)
```

After these changes, in the next section we will perform some visualizations to know the distributions of the variables, relationship between them, etc.



# Exploratoy Data Analysis (EDA)

Our two main variables of interest are cumulative `deaths` and `confirmed` cases. First of all, let's see how they are distributed.

```{r, fig.cap="Cumulative deaths and confirmed cases in Spain"}
a <- spain %>%
  ggplot(aes(x = date, y = deaths)) +
  geom_line()

b <- spain %>%
  ggplot(aes(x = date, y = confirmed)) +
  geom_line()

a + b 
```

As we can observe, there are some mistakes in the data: in the cumulative deaths, there is a drop around June, and in the cumulative confirmed cases, there is another drop in February, which do not make any sense since we are considering **cumulative** cases. Therefore, to fix that error, we will give to that day the value for the previous days in all days that are in that descent.

```{r}
for (i in 1:(nrow(spain)-1)){
  if (spain$deaths[i+1] < spain$deaths[i]) spain$deaths[i+1] <- spain$deaths[i]
  if (spain$confirmed[i+1] < spain$confirmed[i]) spain$confirmed[i+1] <- spain$confirmed[i]
}
```

```{r, fig.cap="Cumulative deaths and confirmed cases fixed"}
a <- spain %>%
  ggplot(aes(x = date, y = deaths)) +
  geom_line()

b <- spain %>%
  ggplot(aes(x = date, y = confirmed)) +
  geom_line()

a + b 
```

Now let's focus on the vaccines administered and the hospitalized people:

```{r}
a <- spain %>%
  ggplot(aes(x = date, y = vaccines)) +
  geom_line()

b <- spain %>%
  ggplot(aes(x = date, y = hosp)) +
  geom_line()

c <- spain %>%
  ggplot(aes(x = date, y = icu)) +
  geom_line()

a + b + c
```

Due to the missing values, we have discontinuous plots. These missing values appear because there are some places in Spain where the vaccination is stopped on weekends, or because these data is not recorded on weekends. Therefore, we will need a statistical method to impute these values, which will be done in the next section. However, for the other two variables, there is no information prior to July, so we will not take them into account because it is not realistic. 

Then, we are going to see the relationships between our target variables, deaths and confirmed, and some of the categorical predictors. Below, we can see how predictors like `stay_home`, `workplace_closing`, `gatherings_restrictions` and `internal_movement` are related with the confirmed cases:

```{r}
a <- spain %>%
  ggplot(aes(x = date, y = confirmed, color = stay_home)) +
  labs(y = " ", x = "") +
  ggtitle("Confirmed cases") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

b <- spain %>%
  ggplot(aes(x = date, y = confirmed, color = workplace_closing)) +
  labs(y = " ") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

c <- spain %>%
  ggplot(aes(x = date, y = confirmed, color = gatherings_restrictions)) +
  labs(y = " ", x = "") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

d <- spain %>%
  ggplot(aes(x = date, y = confirmed, color = internal_movement)) +
  labs(y = " ") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

(a / b) | (c / d)
```

The first plot in the top left corner shows us that the variable `stay_home` is wrongly collected, since it was not mandatory to stay at home after the summer, so we must change it. Also, we can observe how after the summer the measures were much more restrictives than during the summer because of the increment of new cases. For the cummulative deaths, we can see it below: 

```{r}
spain$stay_home[278:451] <- "recommended"
```


```{r}
a <- spain %>%
  ggplot(aes(x = date, y = deaths, color = stay_home)) +
  labs(y = " ", x = "") +
  ggtitle("Deaths") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

b <- spain %>%
  ggplot(aes(x = date, y = deaths, color = workplace_closing)) +
  labs(y = " ") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

c <- spain %>%
  ggplot(aes(x = date, y = deaths, color = gatherings_restrictions)) +
  labs(y = " ", x = "") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

d <- spain %>%
  ggplot(aes(x = date, y = deaths, color = internal_movement)) +
  labs(y = " ") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

(a / b) | (c / d)
```

Again, after summer the measures become more agressive due to the new cases. In the following section, we will see how to modify some variables after we have more knowledge about them.

# Feature Engineering

```{r}
calculate_mode <- function(x) {
  uniqx <- unique(x)
  uniqx[which.max(tabulate(match(x, uniqx)))]
}

spain <- spain %>%
  mutate(
    new_date = as.Date(cut(date, "week"))
  ) %>%
  group_by(new_date) %>%
  mutate(
    deaths = sum(deaths),
    confirmed = sum(confirmed),
    vaccines = sum(vaccines),
    hosp = sum(hosp),
    school_closing = calculate_mode(school_closing),
    workplace_closing = calculate_mode(workplace_closing),
    gatherings_restrictions = calculate_mode(gatherings_restrictions),
    stay_home = calculate_mode(stay_home),
    internal_movement = calculate_mode(internal_movement)
  ) %>%
  ungroup() %>%
  filter(date %in% new_date)
skimr::skim(spain)
```


```{r}
spain_new_data <- COVID19::covid19(country = "spain", start = "2021-04-16")
skimr::skim(spain)
```

In this section, based on the previous analysis of the variables, we should decide which changes should be done in our model, which are usually called **preprocessing** steps. Our preprocessing steps will be:

1. Divide the date in day, month and year, since the month and the year could be very important in the outcomes.

2. Since we want to predict the deaths and confirmed cases in the following days, we should take into account how many deaths and confirmed cases were the days before. Therefore, we will create some new variables which will be the deaths and confirmed cases lagged, i.e., we will consider in our model what happened in the previous days to be able to predict in a better way tomorrow.

3. For the variable `vaccines`, we will impute the 30 NAs we have by doing a linear regression, where the outcome is our variable vaccines, and we will take as predictors


```{r}
# 1st Step:
spain <- spain %>% 
  mutate(
    month = as.factor(month(date)),
    year = as.factor(year(date))
  )

spain_new_data <- spain_new_data %>% 
  mutate(
    month = as.factor(month(date)),
    year = as.factor(year(date))
  )

# 2nd Step:
spain <- spain %>%
  mutate(
    lag_1_deaths = lag(deaths),
    lag_1_confirmed = lag(confirmed)
  )

spain_new_data <- spain_new_data %>%
  mutate(
    lag_1_deaths = lag(deaths),
    lag_1_confirmed = lag(confirmed)
  )

rec_deaths <-
  recipe(deaths ~ lag_1_deaths + lag_1_confirmed + confirmed + month + year,
         data = spain) 

rec_deaths_prep <- prep(rec_deaths)
spain_prep <- bake(rec_deaths_prep, new_data = NULL)
spain_test <- bake(rec_deaths_prep, new_data = spain_new_data)

lm_spec <-
  linear_reg() %>%
  set_engine('lm')

lm_wflow <- 
  workflow() %>%
  add_model(lm_spec) %>%
  add_recipe(rec_deaths)

lm_fit <- fit(lm_wflow, data = spain)
tidy(lm_fit)

predictions <- predict(lm_fit, new_data = spain_prep)
predictions <- predictions$.pred

spain %>%
  ggplot(aes(x = date, y = deaths)) +
  geom_line() + 
  geom_line(y = predictions, color = "red")
```


```{r}

```


```{r}
deaths_day <- (spain$deaths - lag(spain$deaths))[-1]
confirmed_day <- (spain$confirmed - lag(spain$confirmed))[-1]
spain <- spain[-1, ]

spain <- spain %>%
  mutate(
    deaths_acc = deaths,
    confirmed_acc = confirmed,
    deaths = deaths_day,
    confirmed = confirmed_day
  )

spain <- spain %>%
  mutate(
    deaths_100k = (deaths*100000)/population,
    confirmed_100k = (confirmed*100000)/population
  )

spain %>%
  ggplot(aes(x = date, y = deaths_100k)) +
  geom_line()
spain %>%
  ggplot(aes(x = date, y = confirmed)) +
  geom_line()
```


```{r}


spain <- spain %>%
  mutate(
    deathsLag1 = lag(deaths)
  )
spain <- spain[-1, ]

mod1 <- lm(deaths ~ deathsLag1 + month + year + , data = spain)

spain %>%
  ggplot(aes(x = date, y = deaths)) +
  geom_line() + 
  geom_line(y = predict(mod1), color = "red")
  
ggplot(data, aes(x=Date, y=CO2)) +
  geom_line(color="red", size=1.2) + 
  stat_smooth(method="lm", formula=y ~ x, se=FALSE, col="black") +
  theme_minimal()
```



# Model tuning and selection

# References
