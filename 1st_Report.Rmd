---
title: '**First Part: COVID-19 in Spain**'
subtitle: '**Advanced Regression And Prediction**'
author: '*Roberto Jes√∫s Alcaraz Molina*'
date: "09/05/2021"
output:
  pdf_document:
    number_section: true
    highlight: tango
    fig_caption: yes
    toc: true
    # toc_depth: 4
header-includes: 
- \usepackage{float}
- \usepackage{amsbsy}
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{subfig}
- \usepackage{booktabs}
bibliography: references.bib
---

```{=tex}
\begin{center}
\includegraphics[width=3in]{logouc3m}
\end{center}
```
\newpage

```{r, echo = F}
# Packages
# devtools::install_github("stevenpawley/recipeselectors")
pacman::p_load(COVID19, tidyverse, tidymodels, rsample, recipes, parsnip, 
               yardstick, workflows, tune, patchwork, lubridate, recipeselectors,
               doParallel)

# Model packages
pacman::p_load(ranger, mixOmics, plsmod)

# For ggplot
theme_set(theme_bw())

# spain <- COVID19::covid19(country = "spain", start = "2020-01-22", end = "2021-04-11")
# saveRDS(spain, "spain.RDS")
```

```{r include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      echo = F, 
                      message = FALSE,
                      eval = T,
                      fig.pos="H", 
                      fig.align="center",
                      fig.width=15,
                      cache=FALSE, error = TRUE)
```

# INTRODUCTION

The aim of this project is to analyze the coronavirus pandemic (COVID-19) in Spain in general, and in Castilla-La Mancha and Comunidad de Madrid regions, in particular, in order to see what would have happened if policy measures had been taken before. The data has been taken from the R package `COVID19` [@guidotti2020].

```{r}
spain <- readRDS("spain.RDS")
```

# DATA CLEANING

<https://covid19datahub.io/articles/doc/data.html>

These three COVID-19 data sets contain 446 observations, which are the days from the 22nd of January 2020 until the 11th of March 2021, and 36 and 38 variables for Spain and the regions respectively, divided in 5 categories: *identifiers*, *COVID-19 variables*, *policy measures*, *geographic information* and *external keys*.

Regarding the identifiers, we will select both variables: `id`, which denote the country or the region, and date. In the second group, we have variables related with the COVID-19 such as the cumulative number of deaths, confirmed cases, test, etc. For the moment, we will select all of them and then we will decide. In the policy measures, we have very important variables for the development of the pandemic and for our study, like `workplace_closing`, `stay_home_restrictions` or `internal_movement_restrictions`, so we must take them into account. Finally, there are other geographical variables that could be interesting for our models. A description of our variables can be seen below:

```{r, eval=F}
skimr::skim(spain)
```

```{r}
population <- spain$population[1]
spain <- spain %>%
  select(date, deaths, confirmed, vaccines, hosp, icu, stay_home_restrictions, school_closing, workplace_closing, transport_closing, gatherings_restrictions, internal_movement_restrictions)
spain <- spain[, -1]
```

| **Variable**                     | **Description**                                          |
|:---------------------------------|----------------------------------------------------------|
| `id`                             | Unique identifier.                                       |
| `date`                           | Observation date.                                        |
| `deaths`                         | Cumulative number of deaths.                             |
| `test`                           | Cumulative number of test.                               |
| `confirmed`                      | Cumulative number of confirmed cases.                    |
| `vaccines`                       | Cumulative number of doses administered (single dose).   |
| `hosp`                           | Number of hospitalized patients on date.                 |
| `icu`                            | Number of hospitalized patients in ICUs on date.         |
| `population`                     | Total population.                                        |
| `stay_home_restrictions`         | Indicates the measures of staying at home.               |
| `school_closing`                 | Indicates the measures in education.                     |
| `workplace_closing`              | Indicates the measures of the workplace.                 |
| `transport_closing`              | Indicates the measures in the public transport.          |
| `gatherings_restrictions`        | Indicates the measures of gatherings.                    |
| `internal_movement_restrictions` | Indicates the measures of the movements between regions. |

We have realized that all numerical variables have **missing values**. Some of them like the deaths or confirmed cases have them at the beginning, but we have no problem with that because there were not any cases at that time, so we will give 0 to these values. However, there are other variables for which we have to think what to do with their missing values very carefully. For instance, for the tests, there are 399 missing values out of 451 observations, so we will remove it because there is no much information. For the vaccines, we have 378, which we might expect that since the first day we had vaccines was the 3rd of January of 2021 but also, we have some of them in the weekends. For the number of hospitalized people and the ICU people, we have again 303 NAs, but for the moment they will remain in the data set. How to deal with these variables that have missing values will be seen in next sections. Finally, the variables for the measures do not have any missing value.

```{r}
spain <- spain %>%
  mutate(
    deaths = replace(deaths, is.na(deaths), 0),
    confirmed = replace(confirmed, is.na(confirmed), 0)
  )

spain$vaccines[1:348] <- 0
```

After that, we should modify our categorical variables, since they are encoded as integers. The first one, `stay_home_restrictions`, will have three categories: no measures, require not leaving house with exceptions (exercise) and not leaving the house. The next one, `school_closing` has another four categories: no measures, recommended closing, require closing for some schools and require closing. For `workplace_closing` we have no measures, recommended closing, require closing for some sectors and require closing. For `transport_closing` we have two levels: no measures and recommended closing. For `gatherings_restrictions`: no measures, restrictions between 10-100 people and restrictions on gatherings of less than 10 people. Finally, the variable `internal_movement_restrictions` has no measures, recommend closing or require closing.

```{r}
# For Spain
spain <- spain %>%
  mutate(
    stay_home = factor(stay_home_restrictions, 
                       levels = c(0, 1, 2),
                       labels = c("no", "recommended", "mandatory")),
    
    school_closing = factor(school_closing, 
                            levels = c(0, 1, 2, 3),
                            labels = c("no", "recommended", "require", "mandatory")),
    
    workplace_closing = factor(workplace_closing, 
                               levels = c(0, 1, 2, 3),
                               labels = c("no", "recommended", "require", "mandatory")),
    
    transport_closing = factor(transport_closing, 
                               levels = c(0, 1),
                               labels = c("no", "recommended")),
    
    gatherings_restrictions = factor(gatherings_restrictions, 
                                     levels = c(0, 1, 2, 3, 4),
                                     labels = c("no", "no", "no", "10-100", "<10")),
    
    internal_movement_restrictions = factor(internal_movement_restrictions, 
                                            levels = c(0, 1, 2),
                                            labels = c("no", "recommended", "mandatory")),
  ) %>%
  select(-stay_home_restrictions)
```

After these changes, in the next section we will perform some visualizations to know the distributions of the variables, relationship between them, etc.



# EXPLORATORY DATA ANALYSIS (EDA)

Our two main variables of interest are cumulative `deaths` and `confirmed` cases. First of all, let's see how they are distributed.

```{r, fig.cap="Cumulative deaths and confirmed cases in Spain"}
p1 <- spain %>%
  ggplot(aes(x = date, y = deaths)) +
  geom_line()

p2 <- spain %>%
  ggplot(aes(x = date, y = confirmed)) +
  geom_line()

p1 + p2 
```

As we can observe, there are some mistakes in the data: in the cumulative deaths, there is a drop around June, and in the cumulative confirmed cases, there is another drop in February, which do not make any sense since we are considering **cumulative** cases. Therefore, to fix that error, we will give to that day the value for the previous days in all days that are in that descent.

```{r}
for (i in 1:(nrow(spain)-1)){
  if (spain$deaths[i+1] < spain$deaths[i]) spain$deaths[i+1] <- spain$deaths[i]
  if (spain$confirmed[i+1] < spain$confirmed[i]) spain$confirmed[i+1] <- spain$confirmed[i]
}
```

```{r, fig.cap="Cumulative deaths and confirmed cases fixed"}
p1 <- spain %>%
  ggplot(aes(x = date, y = deaths)) +
  geom_line()

p2 <- spain %>%
  ggplot(aes(x = date, y = confirmed)) +
  geom_line()

p1 + p2 
```

Now let's focus on the vaccines administered and the hospitalized people:

```{r}
p1 <- spain %>%
  ggplot(aes(x = date, y = vaccines)) +
  geom_line()

p2 <- spain %>%
  ggplot(aes(x = date, y = hosp)) +
  geom_line()

p3 <- spain %>%
  ggplot(aes(x = date, y = icu)) +
  geom_line()

p1 + p2 + p3
```

Due to the missing values, we have discontinuous plots. These missing values appear because there are some places in Spain where the vaccination is stopped on weekends, or because these data is not recorded on weekends. For the vaccination, as we have done before for the deaths and confirmed cases, we will take the value from the day before. However, for the other two variables, there is no information prior to July, so we will not take them into account because it is not realistic. 

```{r}
for (i in 1:nrow(spain)-1){
  if (is.na(spain$vaccines[i+1])) spain$vaccines[i+1] <- spain$vaccines[i]
}

spain <- spain %>%
  select(-hosp, -icu)
```


Then, we are going to see the relationships between our target variables, deaths and confirmed, and some of the categorical predictors. Below, we can see how predictors like `stay_home`, `workplace_closing`, `gatherings_restrictions` and `internal_movement_restrictions` are related with the confirmed cases:

```{r}
p1 <- spain %>%
  ggplot(aes(x = date, y = confirmed, color = stay_home)) +
  labs(y = " ", x = "") +
  ggtitle("Confirmed cases") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

p2 <- spain %>%
  ggplot(aes(x = date, y = confirmed, color = workplace_closing)) +
  labs(y = " ") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

p3 <- spain %>%
  ggplot(aes(x = date, y = confirmed, color = gatherings_restrictions)) +
  labs(y = " ", x = "") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

p4 <- spain %>%
  ggplot(aes(x = date, y = confirmed, color = internal_movement_restrictions)) +
  labs(y = " ") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

(p1 / p2) | (p3 / p4)
```

The first plot in the top left corner shows us that the variable `stay_home` is wrongly collected, since it was not mandatory to stay at home after the summer, so we must change it. Also, we can observe how after the summer the measures were much more restrictives than during the summer because of the increment of new cases. For the cummulative deaths, we can see it below: 

```{r}
spain$stay_home[278:nrow(spain)] <- "recommended"
```


```{r}
p1 <- spain %>%
  ggplot(aes(x = date, y = deaths, color = stay_home)) +
  labs(y = " ", x = "") +
  ggtitle("Deaths") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

p2 <- spain %>%
  ggplot(aes(x = date, y = deaths, color = workplace_closing)) +
  labs(y = " ") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

p3 <- spain %>%
  ggplot(aes(x = date, y = deaths, color = gatherings_restrictions)) +
  labs(y = " ", x = "") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

p4 <- spain %>%
  ggplot(aes(x = date, y = deaths, color = internal_movement_restrictions)) +
  labs(y = " ") +
  theme(
    legend.title = element_text(size = 10), legend.text = element_text(size = 8)
    ) + 
  geom_point()

(p1 / p2) | (p3 / p4)
```

Again, after summer the measures become more agressive due to the new cases. In the following section, we will see how to modify some variables after we have more knowledge about them.



# FEATURE ENGINEERING


```{r}
spain_new_data <- COVID19::covid19(country = "spain", start = "2021-04-12")
skimr::skim(spain)
```

In this section, based on the previous analysis of the variables, we should decide which changes should be done in our data and then, start modeling. Since our variables of interest, deaths and confirmed cases, are cumulative and daily, we will aggregate them to have the **number of deaths and confirmed cases by week**. This decision has been take due to the different human errors that are in the collection of the coronavirus data, and taking the data weekly, we can predict in a better way the future.

On the one hand, to obtain the number of deaths, confirmed cases and vaccines per week, we will compute firstly the daily cases, substracting today's cases minus tomorrow's and then we will add all the cases of the week. On the other hand, for the categorical variables, we will compute the mode of the variables in every week, i.e., we will give the most frequent values to every week. Below, we can our new data set:

```{r}
calculate_mode <- function(x) {
  uniqx <- unique(x)
  uniqx[which.max(tabulate(match(x, uniqx)))]
}

spain <- spain %>%
  mutate(
    new_date = as.Date(cut(date, "week")),
    deaths_day = spain$deaths - lag(spain$deaths),
    confirmed_day = spain$confirmed - lag(spain$confirmed),
    vaccines_day = spain$vaccines - lag(spain$vaccines)
  ) %>%
  group_by(date) %>%
  summarise(
    new_date = new_date,
    date = date,
    deaths_week = sum(deaths_day),
    confirmed_week = sum(confirmed_day),
    vaccines_week = sum(vaccines_day),
    school_closing = calculate_mode(school_closing),
    workplace_closing = calculate_mode(workplace_closing),
    gatherings_restrictions = calculate_mode(gatherings_restrictions),
    stay_home = calculate_mode(stay_home),
    internal_movement_restrictions = calculate_mode(internal_movement_restrictions)
  ) %>%
  ungroup() %>%
  filter(date %in% new_date) %>%
  select(-new_date)
```

```{r}
knitr::kable(head(spain))
```

Now that we have prepared our data, we have to think about what which **preprocessing** steps should we do. These are some changes that we have to apply to our data before we fit the model. Our preprocessing steps will be:

1. Divide the date in month and year and convert it to categorical, because they could be very important for the outcomes.

```{r}
spain <- spain %>%
  mutate(
    month = factor(month(date)),
    year = factor(year(date))
  )
```

2. Since we want to predict the deaths and confirmed cases in the following weeks, we should take into account how many deaths and confirmed cases were the weeks before. Therefore, we will create some new variables which will be the deaths and confirmed cases lagged 3 weeks, i.e., we will consider in our model what happened in the previous weeks to be able to predict in a better way the next month.

```{r}
spain <- spain %>%
  mutate(
    lag_3_deaths_week = lag(deaths_week, n = 3),
    lag_3_confirmed_week = lag(confirmed_week, n = 3)
  ) %>%
  drop_na()
```

3. Before starting fitting models, we should take a look to our predictors. We have 13 which the majority of them are categorical variables, so we must do **feature selection**. To do that, we will use the package `recipeselectors`, which adds some feature selection methods to the `recipes` package, such as variable importance or boluta methods. This time we will use recursive feature elimination, selecting the features that are above the 20% of importance using a random forest model, which are the ones seen below:

```{r}
rfe_model <- rand_forest() %>%
  set_engine("ranger", importance = "permutation") %>%
  set_mode("regression")

select_rec <- 
  recipe(deaths_week ~ ., data = spain) %>%
  step_rm(date) %>%
  step_select_vip(all_predictors(), outcome = "deaths_week", model = rfe_model, threshold = 0.2)

new_variables <- select_rec %>% prep() %>% juice()
spain <- new_variables %>%
  mutate(date = spain$date)
head(select_rec %>% prep() %>% juice())
# knitr::kable(head(select_rec %>% prep() %>% juice()))
```


4. Even though we will **test** our data with the next 3 weeks, we should divide our training data into folds to tune the model parameters and then to compare them. To do that, there is a function called `rolling_origin` from the `rsample` package which can divide our training set into different folds by date, which is very useful for time series models. We will get 10 folds where the analysis set will be the first 12 weeks and the assessment set, the following 3. This method will allow us to tune the different parameters of our models and get the best with the lowest prediction error. After selecting the best one, we will again fit the model in all our training set and then, we will see how it works in our test set.

```{r}
set.seed(123)
spain_rolling <- rolling_origin(
  spain, 
  initial = 12, # number of weeks used to train in each resample
  assess = 3, # number of weeks used to validate in each resample
  cumulative = F,
  skip = 4
  )

# analysis(spain_rolling$splits[[1]])
# assessment(spain_rolling$splits[[1]])
```

5. Finally, it is time to 


```{r}
# Recipes

basic_rec <- 
  recipe(deaths_week ~ ., data = spain) %>%
  step_rm(date)

linear_reg_rec <- 
  basic_rec %>%
  step_nzv(all_numeric_predictors(), freq_cut = 85/5) %>% # remove the zero variance variables
  step_corr(all_numeric_predictors(), threshold = 0.65) %>% # decorrelate predictors
  step_dummy(all_nominal_predictors()) # get dummy variables
  
pls_rec <- 
  basic_rec %>%
  step_nzv(all_numeric_predictors(), freq_cut = 85/5) %>% # remove the zero variance variables 
  step_normalize(all_numeric_predictors()) %>% # center and scale
  step_dummy(all_nominal_predictors()) # get dummy variables
```

# MODEL TUNING AND SELECTION

```{r}
# Models
lm_model <- 
  linear_reg() %>%
  set_engine("lm")
  
ridge_model <- 
  linear_reg(penalty = tune(), mixture = 0) %>%
  set_engine("glmnet") %>%
  set_mode("regression")

lasso_model <- 
  linear_reg(penalty = tune(), mixture = 1) %>%
  set_engine("glmnet") %>%
  set_mode("regression")

elastic_net_model <- 
  linear_reg(penalty = tune(), mixture = tune()) %>%
  set_engine("glmnet") %>%
  set_mode("regression")

pls_model <-
  pls(predictor_prop = tune(), num_comp = tune()) %>%
  set_engine('mixOmics') %>%
  set_mode('regression')
```


```{r}
workflow_setup <- workflow_set(
  preproc = list(
    linear_reg = linear_reg_rec,
    pls        = pls_rec
  ),
  models = list(
    lm          = lm_model,
    ridge       = ridge_model,
    lasso       = lasso_model,
    elastic_net = elastic_net_model,
    pls         = pls_model
  ), cross = T
)

workflow_setup <- workflow_setup %>%
  filter(wflow_id == c("linear_reg_lm", "linear_reg_ridge", "linear_reg_lasso", "linear_reg_elastic_net", "pls_pls"))

autoplot(workflow_tune_results)
```

```{r}
cl <- makePSOCKcluster(8)
registerDoParallel(cl)

grid_ctrl <-
   control_grid(
      save_pred = TRUE,
      save_workflow = TRUE
   )

workflow_tune_results <- workflow_setup %>%
  workflow_map(
    fn = "tune_grid",
    seed = 1503,
    resamples = spain_rolling,
    grid = 25,
    control = grid_ctrl
   )

stopCluster(cl)

autoplot(workflow_tune_results)
```


```{r}
# Linear model

lm_model <- linear_reg() %>%
  set_engine("lm")

lm_wf <- workflow() %>%
  add_recipe(linear_reg_rec) %>%
  add_model(lm_model)

lm_fit <- lm_wf %>%
  fit(data = spain)
tidy(lm_fit)

lm_fit <- lm_wf %>%
  fit_resamples(
    spain_rolling, 
    control = control_resamples(save_pred = T),
    metrics = metric_set(rmse, rsq, mae)
  )
tidy(lm_fit$id)
pull_workflow_fit(lm_fit)

predictions <- lm_fit %>% collect_predictions()

lm_fit %>% collect_metrics()
```

```{r}
# Random forest model
rf_rec <- 
  recipe(deaths_week ~ ., data = spain) %>%
  step_rm(date)
  
rf_spec <- rand_forest(mtry = tune()) %>%
  set_engine("ranger") %>%
  set_mode("regression")

rf_wf <- workflow() %>%
  add_recipe(rf_rec) %>%
  add_model(rf_spec)

rf_parameters <- workflow() %>%
  add_recipe(rf_rec) %>%
  add_model(rf_spec) %>%
  parameters()

set.seed(1234)
rf_tune <- rf_wf %>%
  tune_grid(
    spain_rolling, 
    grid = 20,
    param_info = rf_parameters,
    metrics = metric_set(rmse, rsq, mae)
  )

show_best(rf_tune)

rf_fit <- rf_wf %>%
  fit_resamples(
    spain_rolling, 
    control = control_resamples(save_pred = T),
    metrics = metric_set(rmse, rsq, mae)
  )

predictions <- rf_fit %>% collect_predictions()
rf_fit %>% collect_metrics()
```

```{r}
workflow_setup <- workflow_set(
  preproc = list(
    lm_rec = lm_rec,
    rf_rec = rf_rec
  ),
  models = list(
    lm = lm_spec,
    rf = rf_spec
  ), cross = T
)

grid_ctrl <-
   control_grid(
      save_pred = TRUE,
      parallel_over = "everything",
      save_workflow = TRUE
   )

workflow_tune_results <- workflow_setup %>%
  workflow_map(
      seed = 1503,
      resamples = spain_rolling,
      grid = 25,
      control = grid_ctrl
   )

autoplot(workflow_tune_results)
```




```{r}

spain_rec <- recipe(deaths_week ~ ., data = spain_analysis) %>%
  step_date(date, features = "month") %>%
  remove_role(date, old_role = "predictor") %>%
  step_lag(confirmed_week) %>%
  step_naomit(lag_1_confirmed_week) %>%
  remove_role(all_nominal(), vaccines_week, old_role = "predictor") %>%
  summary()

spain_rec <- recipe(deaths_week ~ confirmed_week + date, data = spain_analysis) %>%
  step_date(date, features = "month") %>%
  remove_role(date, old_role = "predictor") %>%
  step_lag(confirmed_week) 

spain_analysis_prep <- spain_rec %>% prep() %>% bake(new_data = NULL)

lm_spec <- linear_reg() %>%
  set_engine("lm")

lm_wf <- workflow() %>%
  add_model(lm_spec) %>%
  add_recipe(spain_rec)

lm_fit <- lm_wf %>% fit(spain_analysis)
tidy(lm_fit)

predictions <- predict(lm_fit, new_data = spain_analysis_prep)

spain %>%
  ggplot(aes(x = date, y = deaths_week)) +
  geom_line() + 
  geom_line(y = predictions, color = "red") 
```






```{r}
# 1st Step:
spain <- spain %>% 
  mutate(
    month = as.factor(month(new_date)),
    year = as.factor(year(new_date))
  )

spain_new_data <- spain_new_data %>% 
  mutate(
    month = as.factor(month(date)),
    year = as.factor(year(date))
  )

# 2nd Step:
spain <- spain %>%
  mutate(
    lag_1_deaths_week = lag(deaths_week),
    lag_1_confirmed_week = lag(confirmed_week)
  )

spain_new_data <- spain_new_data %>%
  mutate(
    lag_1_deaths_week = lag(deaths_week),
    lag_1_confirmed_week = lag(confirmed_week)
  )

rec_deaths <-
  recipe(deaths_week ~ lag_1_deaths_week + lag_1_confirmed_week + confirmed_week + month + year +
           school_closing + workplace_closing + transport_closing + gatherings_restrictions + stay_home,
         data = spain) 

rec_deaths_prep <- prep(rec_deaths)
spain_prep <- bake(rec_deaths_prep, new_data = NULL)
spain_test <- bake(rec_deaths_prep, new_data = spain_new_data)

lm_spec <-
  linear_reg() %>%
  set_engine('lm')

lm_wflow <- 
  workflow() %>%
  add_model(lm_spec) %>%
  add_recipe(rec_deaths)

lm_fit <- fit(lm_wflow, data = spain)
tidy(lm_fit)

predictions <- predict(lm_fit, new_data = spain_prep)
predictions <- predictions$.pred

spain %>%
  ggplot(aes(x = date, y = deaths_week)) +
  geom_line() + 
  geom_line(y = predictions, color = "red") 

first_model <- spain[-1, ] %>%
  mutate(predictions = predictions[-1]) %>%
  select(date, deaths_week, predictions) %>%
  gather(key = "Variable", value = "value", -date)

first_model %>%
  ggplot(aes(x = date, y = value)) +
  geom_line(aes(color = Variable), size = 1) +
  scale_color_manual(values = c("darkred", "steelblue")) +
  labs(
    y = "Deaths per week",
    x = "Date"
  ) 
```






# REFERENCES
